<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLM Evaluation Lab</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <main class="shell">
    <header class="hero">
      <p class="eyebrow">Local Eval Workflow</p>
      <h1>LLM Evaluation Lab</h1>
      <p class="subtext">
        Validate extraction behavior across classic and reasoning models with a local ChatMock sidecar.
      </p>
    </header>

    <section class="panel dashboard-panel">
      <div class="dash-row">
        <div class="status-pill">
          <span id="proxyDot" class="dot dot-offline"></span>
          <strong id="proxyStatusText">Checking proxy...</strong>
        </div>
        <code id="proxyTarget">http://localhost:8000/v1/chat/completions</code>
      </div>
      <div class="dash-grid">
        <article>
          <h2>Connection Info</h2>
          <pre id="envTemplate"></pre>
        </article>
        <article>
          <h2>Python Snippet</h2>
          <pre id="pythonSnippet"></pre>
        </article>
        <article>
          <h2>Node Snippet</h2>
          <pre id="nodeSnippet"></pre>
        </article>
      </div>
    </section>

    <section class="panel traffic-panel">
      <div class="traffic-header">
        <h2>Live Proxy Traffic (:8000)</h2>
        <div class="traffic-controls">
          <button id="toggleHealthTrafficButton" type="button" class="ghost-button">Show Health</button>
          <button id="trafficViewTableButton" type="button" class="ghost-button active">Table View</button>
          <button id="trafficViewJsonButton" type="button" class="ghost-button">Raw JSON</button>
          <button id="refreshTrafficButton" type="button">Refresh</button>
          <button id="clearTrafficButton" type="button">Clear</button>
        </div>
      </div>
      <p id="trafficStatus" class="status">Waiting for traffic...</p>
      <p class="hint">Tip: double-click a traffic row to inspect full request/response.</p>
      <div id="trafficTableWrap" class="queue-table-wrap">
        <table id="trafficTable" class="queue-table">
          <thead>
            <tr>
              <th>Time</th>
              <th>Method</th>
              <th>Path</th>
              <th>Status</th>
              <th>Duration (ms)</th>
              <th>Preview</th>
            </tr>
          </thead>
          <tbody id="trafficTableBody">
            <tr><td colspan="6" class="empty-row">Waiting for traffic...</td></tr>
          </tbody>
        </table>
      </div>
      <pre id="trafficOutput">[]</pre>
    </section>

    <section class="panel queue-panel">
      <div class="traffic-header">
        <h2>Queue Test</h2>
        <div class="traffic-controls">
          <label for="queueCount">Requests</label>
          <input id="queueCount" type="number" min="2" max="10" value="5">
          <label for="queueSortField">Sort</label>
          <select id="queueSortField" aria-label="Queue sort field">
            <option value="completedAt">Completion</option>
            <option value="elapsedMs">Latency</option>
            <option value="id">Request Id</option>
            <option value="statusCode">Status</option>
          </select>
          <button id="queueSortDirButton" type="button" class="ghost-button">Asc</button>
          <button id="runQueueButton" type="button">Run Queue Burst</button>
        </div>
      </div>
      <p id="queueStatus" class="status">Idle</p>
      <p class="hint">Tip: double-click a queue row preview for full payload details.</p>
      <div id="queueSummaryChips" class="summary-chips"></div>
      <div class="queue-view-controls">
        <button id="queueViewTableButton" type="button" class="ghost-button active">Table View</button>
        <button id="queueViewJsonButton" type="button" class="ghost-button">Raw JSON</button>
      </div>
      <div id="queueTableWrap" class="queue-table-wrap">
        <table id="queueTable" class="queue-table">
          <thead>
            <tr>
              <th data-sort-field="id">Req</th>
              <th data-sort-field="statusCode">Status</th>
              <th data-sort-field="elapsedMs">Latency (ms)</th>
              <th data-sort-field="startedAt">Started</th>
              <th data-sort-field="completedAt">Completed</th>
              <th>Preview</th>
            </tr>
          </thead>
          <tbody id="queueTableBody">
            <tr><td colspan="6" class="empty-row">Run queue test to see per-request results.</td></tr>
          </tbody>
        </table>
      </div>
      <pre id="queueOutput" class="hidden">{"summary":"Run queue test to inspect FIFO behavior and per-request response times."}</pre>
    </section>

    <section class="panel async-panel">
      <div class="traffic-header">
        <h2>Async Sidecar Control</h2>
        <div class="traffic-controls">
          <button id="asyncTabJobsButton" type="button" class="ghost-button active">Jobs</button>
          <button id="asyncTabReplayButton" type="button" class="ghost-button">Replay</button>
          <button id="asyncRefreshAllButton" type="button">Refresh Async Data</button>
        </div>
      </div>

      <div id="asyncJobsPane" class="async-pane">
        <div class="async-grid">
          <article class="card async-card">
            <h3>Submit Async Job</h3>
            <div class="async-form-grid">
              <label for="asyncModelSelect">Model</label>
              <select id="asyncModelSelect" aria-label="Async model selector"></select>

              <label for="asyncPrioritySelect">Priority</label>
              <select id="asyncPrioritySelect" aria-label="Async priority selector">
                <option value="interactive">interactive</option>
                <option value="retry">retry</option>
                <option value="batch" selected>batch</option>
              </select>

              <label class="toggle">
                <input type="checkbox" id="asyncAggressiveToggle">
                Aggressive Trigger
              </label>
              <div></div>

              <label for="asyncFallbackReason">Fallback Reason</label>
              <input id="asyncFallbackReason" type="text" placeholder="e.g. low_confidence">

              <label for="asyncConfidenceBefore">Confidence Before</label>
              <input id="asyncConfidenceBefore" type="number" min="0" max="1" step="0.01" placeholder="0.55">

              <label for="asyncDomAnchor">DOM Anchor</label>
              <input id="asyncDomAnchor" type="text" placeholder="#specs .battery">

              <label for="asyncScreenshotRegion">Screenshot Region</label>
              <input id="asyncScreenshotRegion" type="text" placeholder="top-right">

              <label for="asyncReasoningNote">Reasoning Note</label>
              <input id="asyncReasoningNote" type="text" placeholder="why this extraction path was selected">
            </div>

            <label for="asyncPayloadInput">Payload JSON</label>
            <textarea id="asyncPayloadInput" class="code-input" placeholder='{"model":"gpt-5-high","messages":[{"role":"user","content":"Extract..."}]}'></textarea>

            <div class="traffic-controls">
              <button id="asyncUseCurrentInputButton" type="button" class="ghost-button">Use Current Input</button>
              <button id="asyncSubmitButton" type="button">Submit Job</button>
            </div>
          </article>

          <article class="card async-card">
            <h3>Job Actions</h3>
            <div class="async-form-grid">
              <label for="asyncJobIdInput">Job ID</label>
              <input id="asyncJobIdInput" type="text" placeholder="job-...">
            </div>
            <div class="traffic-controls">
              <button id="asyncStatusButton" type="button" class="ghost-button">Get Status</button>
              <button id="asyncResultButton" type="button" class="ghost-button">Get Result</button>
              <button id="asyncReviewButton" type="button" class="ghost-button">Get Review</button>
              <button id="asyncCancelButton" type="button" class="ghost-button">Cancel</button>
            </div>
            <pre id="asyncJobOutput">{}</pre>
          </article>
        </div>

        <div class="async-grid">
          <article class="card async-card">
            <h3>Queue Snapshot</h3>
            <pre id="asyncQueueOutput">{}</pre>
          </article>
          <article class="card async-card">
            <h3>State, Metrics, Aggressive Report</h3>
            <div class="traffic-controls">
              <button id="asyncRefreshStateButton" type="button" class="ghost-button">State</button>
              <button id="asyncRefreshMetricsButton" type="button" class="ghost-button">Metrics</button>
              <button id="asyncRefreshAggressiveButton" type="button" class="ghost-button">Aggressive</button>
            </div>
            <pre id="asyncStateOutput">{}</pre>
            <pre id="asyncMetricsOutput">{}</pre>
            <pre id="asyncAggressiveOutput">{}</pre>
          </article>
        </div>
      </div>

      <div id="asyncReplayPane" class="async-pane hidden">
        <div class="async-grid">
          <article class="card async-card">
            <h3>Run Replay Harness</h3>
            <div class="async-form-grid">
              <label for="replayNameInput">Replay Name</label>
              <input id="replayNameInput" type="text" value="default-replay">

              <label for="replayBaselineModel">Baseline Model</label>
              <select id="replayBaselineModel" aria-label="Replay baseline model"></select>

              <label for="replayCandidateModel">Candidate Model</label>
              <select id="replayCandidateModel" aria-label="Replay candidate model"></select>
            </div>

            <label for="replayCasesInput">Cases JSON (array)</label>
            <textarea id="replayCasesInput" class="code-input" placeholder='[{"id":"case-1","payload":{"messages":[{"role":"user","content":"..."}]},"expected":{"field":"value"}}]'></textarea>

            <div class="traffic-controls">
              <button id="replayUseCurrentInputButton" type="button" class="ghost-button">Use Current Input</button>
              <button id="replayRunButton" type="button">Run Replay</button>
            </div>
          </article>

          <article class="card async-card">
            <h3>Replay Report</h3>
            <div class="async-form-grid">
              <label for="replayIdInput">Replay ID</label>
              <input id="replayIdInput" type="text" placeholder="replay-...">
            </div>
            <div class="traffic-controls">
              <button id="replayLoadButton" type="button" class="ghost-button">Load Report</button>
            </div>
            <pre id="replayOutput">{}</pre>
          </article>
        </div>
      </div>

      <p id="asyncStatus" class="status">Async control idle.</p>
    </section>

    <section class="panel input-panel">
      <div class="input-header">
        <h2>Input</h2>
        <div class="controls">
          <label for="modelSelect">Model</label>
          <select id="modelSelect" aria-label="Model selector"></select>
          <label class="toggle">
            <input type="checkbox" id="aggressiveToggle">
            Aggressive Mode
          </label>
          <button id="runButton" type="button">Run Extraction</button>
        </div>
      </div>
      <div id="imageRow" class="image-row hidden">
        <label for="imageFile">Image Input</label>
        <input id="imageFile" type="file" accept="image/*">
      </div>
      <textarea
        id="inputText"
        placeholder="Paste raw text, HTML, logs, scraped payloads, or complex instructions..."
      ></textarea>
      <p id="statusMessage" class="status">Idle</p>
    </section>

    <section class="panel output-panel">
      <div class="output-grid">
        <article class="card">
          <h3>Forwarded Request</h3>
          <pre id="requestOutput">{}</pre>
        </article>
        <article class="card">
          <h3>Raw JSON Response</h3>
          <pre id="rawOutput">{}</pre>
        </article>
        <article class="card">
          <h3>Readable Output</h3>
          <div id="renderedOutput" class="rendered-output">
            <p class="placeholder">Run an extraction to see a rendered table or markdown output.</p>
          </div>
        </article>
      </div>
    </section>
  </main>

  <div id="inspectorModal" class="modal hidden">
    <div id="inspectorBackdrop" class="modal-backdrop"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="inspectorTitle">Request Inspector</h3>
        <button id="inspectorCloseButton" type="button" class="ghost-button">Close</button>
      </div>
      <div class="modal-grid">
        <article class="modal-card">
          <h4>Request</h4>
          <pre id="inspectorRequest">{}</pre>
        </article>
        <article class="modal-card">
          <h4>Response</h4>
          <pre id="inspectorResponse">{}</pre>
        </article>
      </div>
    </div>
  </div>

  <script src="/app.js"></script>
  <script src="/async-panel.js"></script>
</body>
</html>
